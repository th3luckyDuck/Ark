<!DOCTYPE html>
<html>
  <head>
    <!--
    Ark - Browser Edition (A-Frame + Physics + Gamepad)

    Changes:
    - Removed Altspace SDK and all altspace.* usage.
    - Converted old <a-animation> to modern A-Frame animation components (animation__name with startEvents).
    - Added gravity and collision using aframe-physics-system (CANNON.js).
    - Fixed emitToTargets to only target A-Frame entities and emit events those entities listen to.
    - Replaced n-text and n-sound with A-Frame text and sound; added shims so existing code paths still work.
    - Implemented Xbox controller via Gamepad API (Left Stick/D-Pad lanes, A jump, X mute/unmute, Start reset).
    - UI is clickable with mouse via cursor/raycaster, and playable without VR.
    -->

    <meta charset="utf-8">
    <title>Ark</title>
    <meta name="Ark" content="Ark">

    <!-- Modern A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Physics system (gravity & collisions) -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>

    <script>
      // Utility: Emit an event on target entities (only A-Frame entities).
      function emitToTargets(type, targets) {
        targets.forEach(sel => {
          const el = document.querySelector(sel);
          if (!el || !el.isEntity) return; // ensure A-Frame entity
          el.emit(type, null, false);
        });
      }

      // Convert legacy n-text payload to A-Frame text component.
      function setNText(el, payload) {
        if (!el) return;
        const val = (payload && payload.text) ? payload.text : String(payload || '');
        const match = String(val).match(/<color=([^>]+)>\s*(.*)/i);
        const color = match ? match[1].trim() : '#6FF3E8';
        const value = match ? match[2].trim() : val;
        el.setAttribute('text', `value: ${value}; color: ${color}; align: left`);
      }

      // Gamepad controller mapping
      const GamepadController = {
        deadZone: 0.25,
        prevButtons: [],
        laneIndex: 1, // lanes: 0 left, 1 center, 2 right
        muted: false,
        start() {
          const loop = () => {
            const pads = navigator.getGamepads ? navigator.getGamepads() : [];
            const pad = pads && pads[0];
            if (pad) this.handlePad(pad);
            requestAnimationFrame(loop);
          };
          loop();
        },
        handlePad(pad) {
          // Left stick horizontal for lanes
          const ax = pad.axes[0] || 0;
          if (ax > this.deadZone) this.setLane(2);
          else if (ax < -this.deadZone) this.setLane(0);
          else this.setLane(1);

          // D-pad left/right
          if (pad.buttons[14]?.pressed) this.setLane(0);
          if (pad.buttons[15]?.pressed) this.setLane(2);

          // A = jump
          this.edgeTrigger(0, pad.buttons[0]?.pressed, () => this.jump());

          // X = mute toggle
          this.edgeTrigger(2, pad.buttons[2]?.pressed, () => this.toggleMute());

          // Start = reset
          this.edgeTrigger(9, pad.buttons[9]?.pressed, () => {
            const resetBtn = document.querySelector('#resetb');
            resetBtn && resetBtn.click();
          });

          this.prevButtons = pad.buttons.map(b => b.pressed);
        },
        edgeTrigger(index, pressed, cb) {
          const was = this.prevButtons[index] || false;
          if (pressed && !was) cb();
        },
        setLane(idx) {
          if (idx === this.laneIndex) return;
          this.laneIndex = idx;
          const laneTargets = ['#leftgo', '#centergo', '#rightgo'];
          emitToTargets('movetp', [laneTargets[idx]]);
        },
        jump() {
          const player = document.querySelector('#player');
          if (!player) return;
          // Simple jump impulse if grounded
          const body = player.body;
          if (!body) return;
          const vy = body.velocity.y;
          // Grounded heuristic
          if (Math.abs(vy) < 0.05) {
            // Apply upward impulse
            body.velocity.y = 5.5;
            emitToTargets('jump', ['#jumpa', '#jumpb']);
          }
        },
        toggleMute() {
          this.muted = !this.muted;
          const ids = ['#song', '#song2', '#song3', '#song4', '#song5', '#song6', '#begin3', '#gameovers', '#lazer', '#click', '#click2', '#hah1', '#hah2', '#hah3'];
          ids.forEach(sel => {
            const el = document.querySelector(sel);
            if (el && el.components && el.components.sound) {
              el.setAttribute('sound', `volume: ${this.muted ? 0 : (el.components.sound.data.volume || 0.3)}`);
            }
          });
        }
      };

      // Ensure we have a desktop cursor for clicking
      AFRAME.registerComponent('ensure-cursor', {
        init() {
          const scene = this.el;
          let camera = scene.querySelector('[camera]');
          if (!camera) {
            camera = document.createElement('a-entity');
            camera.setAttribute('camera', '');
            camera.setAttribute('position', '0 1.6 0');
            scene.appendChild(camera);
          }
          // Add cursor/raycaster to camera
          camera.setAttribute('cursor', 'rayOrigin: mouse; fuse: false');
          camera.setAttribute('raycaster', 'objects: .interactable');
        }
      });

      // Click-to-emit helper
      function setupWireClick(el, emit, targets) {
        if (!el) return;
        el.classList.add('interactable');
        el.addEventListener('click', () => emitToTargets(emit, targets));
      }

      // Simple "lane target" component: moves the player to a lane x/z with animation
      AFRAME.registerComponent('lane-target', {
        schema: { x: {type:'number', default: 0}, z: {type:'number', default: 0} },
        init() {
          this.el.addEventListener('movetp', () => {
            const player = document.querySelector('#player');
            if (!player) return;
            const pos = player.getAttribute('position');
            // Soft snap horizontally (keep y)
            player.setAttribute('animation__lane', {
              property: 'position',
              to: `${this.data.x} ${pos.y} ${this.data.z}`,
              dur: 250,
              easing: 'easeOutQuad',
              startEvents: 'movetp',
            });
            player.emit('movetp');
          });
        }
      });

      // Ground detection helper
      AFRAME.registerComponent('ground', {
        init() {
          // No-op; static-body gives collision surface
        }
      });

      // Collectible/counter mock: if player passes an invisible volume, increment score
      AFRAME.registerComponent('score-volume', {
        init() {
          this.el.addEventListener('body-loaded', () => {});
        }
      });
    </script>
  </head>

  <body>
    <a-scene physics="gravity: -9.8" background="color: #000" ensure-cursor>

      <a-assets>
        <img id="leftp" src="left.jpg">
        <img id="centerp" src="center.jpg">
        <img id="rightp" src="right.jpg">
        <img id="jumpp" src="jump.jpg">
        <img id="mutep" src="mute.jpg">
        <img id="arkwall" src="arkwall.jpg">
        <img id="credit" src="credit.jpg">
        <img id="startp" src="start.jpg">
        <img id="resetp" src="reset.jpg">
        <img id="joinp" src="join.jpg">
        <img id="lobbyp" src="lobby.jpg">
        <img id="scorep" src="score.jpg">
        <img id="scoreboardp" src="scoreboard.jpg">
        <img id="joinsmallp" src="joinsmall.jpg">
        <img id="lobbysmallp" src="lobbysmall.jpg">
        <img id="p1" src="1.jpg">
        <img id="p2" src="2.jpg">
        <img id="p3" src="3.jpg">
        <a-asset-item id="run-obj" src="run.obj"></a-asset-item>
        <a-asset-item id="run-mtl" src="run.mtl"></a-asset-item>
      </a-assets>

      <!-- Scoreboard stub -->
      <a-entity id="scoreboard"></a-entity>

      <a-entity id="thegame">
        <!-- Player with physics -->
        <a-entity id="player" position="0 1.6 0" dynamic-body="mass:1; linearDamping:0.01; angularDamping:0.01">
          <a-entity id="playerCam" camera look-controls wasd-controls="acceleration: 12"></a-entity>
        </a-entity>

        <a-light id="light1" type="directional" intensity="2.0" position="150 15 15"></a-light>

        <!-- Lane markers and targets -->
        <a-entity id="leftstop" position="-1.5 0 0" lane-target="x: -1.5; z: 0"></a-entity>
        <a-entity id="centerstop" position="0 0 0" lane-target="x: 0; z: 0"></a-entity>
        <a-entity id="rightstop" position="1.5 0 0" lane-target="x: 1.5; z: 0"></a-entity>

        <!-- HUD / Menu -->
        <a-entity id="menu1" position="0.805 -0.18 0">
          <a-entity id="scoreshow" position='-0.66 0.35 -1.67' rotation="-25 0 0" scale="0.08 0.08 0.03"></a-entity>
          <a-plane id="scoreshow3" src="#scorep" position='-0.81 0.35 -1.70' rotation="-25 0 0" width="0.55" height="0.17" class="interactable"></a-plane>

          <a-plane id="joinsm" src='#joinsmallp' position='-0.61 0.2 -1.62' rotation="-25 0 0" width="0.15" height="0.15" class="interactable"></a-plane>
          <a-plane id="lobbysm" src='#lobbysmallp' position='-0.61 -100 -1.62' rotation="-25 0 0" width="0.15" height="0.15" class="interactable"></a-plane>

          <a-plane id="songT" src='#mutep' position='-1.01 0.2 -1.62' rotation="-25 0 0" width="0.15" height="0.15" class="interactable"></a-plane>

          <a-plane id="jumpb" src='#jumpp' position='-0.81 0.2 -1.62' rotation="-25 0 0" width="0.15" height="0.15" class="interactable"
                   animation__press="property: position; to: -0.81 -1000 -1.62; dur: 5000; startEvents: jump"></a-plane>

          <a-plane id="leftT" src='#leftp' position='-01.01 0.05 -1.55' rotation="-25 0 0" width="0.15" height="0.15" class="interactable"></a-plane>
          <a-plane id="centerT" src='#centerp' position='-0.81 0.05 -1.55' rotation="-25 0 0" width="0.15" height="0.15" class="interactable"></a-plane>
          <a-plane id="rightT" src='#rightp' position='-0.61 0.05 -1.55' rotation="-25 0 0" width="0.15" height="0.15" class="interactable"></a-plane>
        </a-entity>

        <!-- Jump effect block -->
        <a-entity id="jumpa" position="0 0 0"
                  animation__rise="property: position; to: 0 8 0; dur: 2000; startEvents: jump">
          <a-box scale="10 10 10" position="-0.2 -5 0" material="color: #5ed4ff; opacity: 0"></a-box>
          <a-box scale="10 10 10" position="-10.1 5 0" material="color: #5ed4ff; opacity: 0"></a-box>    
          <a-box scale="10 10 10" position="-0.2 5 -9.9" material="color: #5ed4ff; opacity: 0"></a-box>
          <a-box scale="0.5 10 10" position="4.7 5 0" material="color: #5ed4ff; opacity: 0"></a-box>
          <a-box scale="10 10 10" position="-0.2 5 9.9" material="color: #5ed4ff; opacity: 0"></a-box>
        </a-entity>

        <!-- Lane portals -->
        <a-entity id="leftgo"></a-entity>
        <a-entity id="centergo"></a-entity>
        <a-entity id="rightgo"></a-entity>

        <!-- Countdown -->
        <a-entity id="countdowne">
          <a-plane id="threeb" src='#p3' position='0 -100 -1.62' width="1" height="1"></a-plane>
          <a-plane id="twob" src='#p2' position='0 -100 -1.62' width="1" height="1"></a-plane>
          <a-plane id="oneb" src='#p1' position='0 -100 -1.62' width="1" height="1"></a-plane>
        </a-entity>

        <!-- Room walls and initial drop -->
        <a-entity id="room" position="0 0 0"
                  animation__startdrop="property: position; to: 0 -10.2 0; dur: 2000; startEvents: start1">
          <a-box scale="10 10 10" position="-10 5 0" material="color: #5ed4ff"></a-box>    
          <a-box scale="10 10 10" position="0 5 -10" material="color: #5ed4ff"></a-box>
          <a-box scale="10 10 10" position="10 5 0" material="color: #5ed4ff"></a-box>
          <a-box scale="10 10 10" position="0 5 10" material="color: #5ed4ff"></a-box>
          <a-box scale="10 10 10" position="0 -5 0" material="color: #5ed4ff"></a-box>
        </a-entity>

        <!-- Moving wall set (kept one loop for effect) -->
        <a-entity id="move" position="-1000 0 0"
                  animation__loop="property: position; to: 1000 0 0; dur: 20000; easing: linear; loop: true"></a-entity>

        <!-- Start triggers -->
        <a-entity id="startcc2" position="0 -30 0"
                  animation__start1enter="property: position; to: 0 0 0; dur: 100; delay: 2000; startEvents: start1"
                  animation__start2exit="property: position; to: 0 -1000 0; dur: 100; startEvents: start2"></a-entity>

        <!-- Start button -->
        <a-entity id="startcc" geometry="primitive: plane; width: 6; height: 1.35"
                  material="src: #startp; opacity: 0.75;"
                  scale="0.6 0.6 0.6" rotation="0 90 0" position="-4.9 2 0"
                  class="interactable"
                  animation__hide="property: position; to: 0 -1000 0; dur: 2500; startEvents: start1"></a-entity>

        <!-- Lobby / Join -->
        <a-entity id="lobbybtn" geometry="primitive: plane; width: 4; height: 1.35"
                  material="src: #lobbyp; opacity: 0.75;"
                  scale="0.5 0.5 0.5" position="4.2 2 0" rotation="0 -90 0"
                  class="interactable"></a-entity>

        <a-entity id="joinh" geometry="primitive: plane; width: 6; height: 1.35"
                  material="src: #joinp; opacity: 0.75;"
                  scale="0.5 0.5 0.5" position="5.1 12 0" rotation="0 90 0"
                  class="interactable"></a-entity>

        <!-- Static room and scoreboard wall -->
        <a-entity id="cube1" position="10 0 0"
                  animation__hide="property: position; to: 0 -1000 0; dur: 1000; startEvents: start1">
          <a-plane width="6" height="4.5" material="src: #arkwall; opacity: 1;" position="0 13 -4.9"></a-plane>
          <a-plane width="1.25" height="2" material="src: #credit; opacity: 1;" position="0 12 4.9" rotation="0 180 0"></a-plane>
          <a-plane width="8" height="8" material="src: #scoreboardp; opacity: 1;" position="-14.9 15.5 0" rotation="0 90 0"></a-plane>
          <a-entity id="lastscore" position="-14.8 16.75 0" rotation="0 90 0"></a-entity>
          <a-entity id="lastscore2" position="-14.8 15.75 0" rotation="0 90 0"></a-entity>
          <a-entity id="lastscore3" position="-14.8 14.75 0" rotation="0 90 0"></a-entity>
          <a-entity id="lastscore4" position="-14.8 13.75 0" rotation="0 90 0"></a-entity>
          <a-entity id="lastscore5" position="-14.8 12.75 0" rotation="0 90 0"></a-entity>
        </a-entity>

        <!-- Sounds -->
        <a-entity id="hah1" position="0 15 0" sound="src: url(ha1.wav); loop: false; autoplay: false; volume: 0.3"></a-entity>
        <a-entity id="hah2" position="0 15 0" sound="src: url(ha2.wav); loop: false; autoplay: false; volume: 0.3"></a-entity>
        <a-entity id="hah3" position="0 15 0" sound="src: url(ha3.wav); loop: false; autoplay: false; volume: 0.3"></a-entity>

        <!-- Tunnel -->
        <a-entity id="tunnel" position="-2500 15 0"
                  animation__scroll="property: position; to: 2500 15 0; dur: 100000; easing: linear; loop: true">
          <a-box scale="500 10 10" position="0 10 0" material="color: #1f4959"></a-box>    
          <a-box scale="500 30 10" position="0 0 -10" material="color: #1f4959"></a-box>
          <a-box scale="500 30 10" position="0 0 10" material="color: #1f4959"></a-box>
        </a-entity>

        <!-- Port start -->
        <a-entity id="outstart" position="0 -100 0" scale="1 1 1"
                  animation__port="property: position; to: 0 0 0; dur: 750; startEvents: startport"></a-entity>

        <!-- Floor and walls (physics surfaces) -->
        <a-plane id="floor" static-body scale="1500 10 1" position="0 0 0" rotation="-90 0 0" material="color: #5ed4ff; opacity: 1"
                 animation__rise="property: position; to: 0 0 0; dur: 2500; startEvents: start1"></a-plane>

        <!-- invisible side walls for OOB -->
        <a-box static-body position="-5 2 0" scale="0.5 5 10" material="opacity:0"></a-box>
        <a-box static-body position="5 2 0" scale="0.5 5 10" material="opacity:0"></a-box>

        <!-- Level sequencers -->
        <a-entity id="start2go" position="0 -1000 -2010"
                  animation__seq="property: position; to: 0 0 0; dur: 5000; delay: 50000; startEvents: start1"></a-entity>
        <a-entity id="start3go" position="200 -1000 -2010"
                  animation__seq="property: position; to: 0 0 0; dur: 5000; delay: 100000; startEvents: start1"></a-entity>
        <a-entity id="start4go" position="400 -1000 -2010"
                  animation__seq="property: position; to: 0 0 0; dur: 5000; delay: 150000; startEvents: start1"></a-entity>
        <a-entity id="start5go" position="600 -1000 -2010"
                  animation__seq="property: position; to: 0 0 0; dur: 5000; delay: 200000; startEvents: start1"></a-entity>

        <!-- Music -->
        <a-entity id="song" position="0 10 0" sound="src: url(arktheme.wav); loop: true; autoplay: false; volume: 0.2"></a-entity>
        <a-entity id="song2" position="0 10 0" sound="src: url(arkpregame.wav); loop: true; autoplay: true; volume: 0.2"></a-entity>
        <a-entity id="song3" position="0 10 0" sound="src: url(arktheme2.wav); loop: true; autoplay: false; volume: 0.2"></a-entity>
        <a-entity id="song4" position="0 10 0" sound="src: url(arktheme3.wav); loop: true; autoplay: false; volume: 0.2"></a-entity>
        <a-entity id="song5" position="0 10 0" sound="src: url(arktheme4.wav); loop: true; autoplay: false; volume: 0.2"></a-entity>
        <a-entity id="song6" position="0 10 0" sound="src: url(level5.wav); loop: true; autoplay: false; volume: 0.3"></a-entity>

        <!-- Boss -->
        <a-obj-model id="boss" scale="50 50 50" src="#run-obj" mtl="#run-mtl" position="-250 -1000 0" rotation="0 90 0"
                     animation__enter="property: position; from: 0 -1000 0; to: -250 0 0; dur: 7500; startEvents: start5"></a-obj-model>

      </a-entity>

      <!-- Reset button -->
      <a-entity id="resetb" geometry="primitive: plane; width: 6; height: 1.35"
                material="src: #resetp; opacity: 0.75;"
                position="13 -1000 0" scale="0.5 0.5 0.5" rotation="0 -90 0"
                class="interactable"
                animation__end="property: position; to: 0 -1000 0; dur: 5000; startEvents: gameend"></a-entity>

      <!-- Guide cube (visual only) -->
      <a-entity position="10 0 0">
        <a-box scale="0.1 10 10" position="-5 15 0" material="color: blue; opacity: 0.1;"></a-box>    
        <a-box scale="10 10 0.1" position="0 15 -5" material="color: blue; opacity: 0.1;"></a-box>
        <a-box scale="0.1 10 10" position="5 15 0" material="color: blue; opacity: 0.1;"></a-box>
        <a-box scale="10 10 0.1" position="0 15 5" material="color: blue; opacity: 0.1;"></a-box>
        <a-box scale="10 0.1 10" position="0 10 0" material="color: blue; opacity: 0.1;"></a-box>
        <a-box scale="10 0.1 10" position="0 20 0" material="color: blue; opacity: 0.1;"></a-box>
      </a-entity>

      <!-- Sound effects -->
      <a-entity id="load" position="0 10 0" sound="src: url(load.wav); loop: false; autoplay: false; volume: 0.7"></a-entity>
      <a-entity id="gameovers" position="0 15 0" sound="src: url(gameover.wav); loop: false; autoplay: false; volume: 1"></a-entity>
      <a-entity id="begin3" position="0 15 0" sound="src: url(begin.wav); loop: false; autoplay: false; volume: 0.3"></a-entity>
      <a-entity id="lazer" position="0 15 0" sound="src: url(lazer.wav); loop: false; autoplay: false; volume: 0.3"></a-entity>
      <a-entity id="click" position="0 15 0" sound="src: url(click.wav); loop: false; autoplay: false; volume: 0.3"></a-entity>
      <a-entity id="click2" position="0 15 0" sound="src: url(click.wav); loop: false; autoplay: false; volume: 0.3"></a-entity>

      <!-- Helper targets -->
      <a-entity id="target"></a-entity>
      <a-entity id="target2"></a-entity>
      <a-entity id="oob"></a-entity>
      <a-entity id="resetport"></a-entity>

      <a-sky radius="1050" color="black"></a-sky>

      <script>
        // Gameplay state
        var gameStarted = true;
        var score = 0;
        var scoring = false;
        var lastscore = 0;
        var lastscore2 = 0;
        var lastscore3 = 0;
        var lastscore4 = 0;
        var lastscore5 = 0;
        var boss = false;

        document.addEventListener('DOMContentLoaded', () => {
          // Initialize text HUD
          setNText(document.querySelector('#scoreshow'), {text:'<color=#6FF3E8> 0'});
          ['#lastscore','#lastscore2','#lastscore3','#lastscore4','#lastscore5'].forEach(sel=>{
            setNText(document.querySelector(sel), {text:'<color=#6FF3E8> 0'});
          });

          // Start gamepad loop
          GamepadController.start();

          // Wire-like click handlers
          document.querySelector('#startcc').addEventListener('click', () => {
            emitToTargets('start1', ['#room','#floor','#right','#left','#startcc','#startcc2','#tunnel','#cube1','#scoreboard','#move','#start2go','#start3go','#start4go','#start5go','#target','#boss','#click']);
            const beginSound = document.querySelector('#begin3').components.sound;
            beginSound && beginSound.playSound();
          });

          setupWireClick(document.querySelector('#lobbybtn'), 'outgo', ['#outstart']);
          setupWireClick(document.querySelector('#joinh'), 'outgo', ['#outstart','#click2','#target2']);
          setupWireClick(document.querySelector('#joinsm'), 'outgo', ['#outstart','#click2','#target2']);
          setupWireClick(document.querySelector('#lobbysm'), 'outgo', ['#outstart','#click2']);

          // Jump and lane buttons
          setupWireClick(document.querySelector('#jumpb'), 'jump', ['#jumpa','#jumpb']);
          setupWireClick(document.querySelector('#leftT'), 'movetp', ['#leftstop']);
          setupWireClick(document.querySelector('#centerT'), 'movetp', ['#centerstop']);
          setupWireClick(document.querySelector('#rightT'), 'movetp', ['#rightstop']);

          // Mute button
          document.querySelector('#songT').addEventListener('click', () => GamepadController.toggleMute());

          // Reset button
          document.querySelector('#resetb').addEventListener('click', () => reset());

          // Initial portal animation
          setTimeout(function() {
            emitToTargets('startport', ['#outstart']);
          }, 1000);

          // Countdown visuals when joining
          document.querySelector('#target2').addEventListener('outgo', function () {
            const threeb = document.querySelector('#threeb');
            threeb.setAttribute('position', '0 1 -1.62');
            setTimeout(function() {threeb.setAttribute('position', '0 -100 0');}, 1000);
            setTimeout(function() {document.querySelector('#twob').setAttribute('position', '0 1 -1.62');}, 1000);
            setTimeout(function() {document.querySelector('#twob').setAttribute('position', '0 -100 0');}, 2000);
            setTimeout(function() {document.querySelector('#oneb').setAttribute('position', '0 1 -1.62');}, 2000);
            setTimeout(function() {document.querySelector('#oneb').setAttribute('position', '0 -100 0');}, 3000);
          });

          // Level music cues
          document.querySelector('#target').addEventListener('start1', function () {
            scoring = true;
            ['#song2','#song3','#song4','#song5','#song6'].forEach(pauseSound);
            playSound('#song');
            document.querySelector('#joinh').setAttribute('position', '5.1 13.5 0');
          });
          document.querySelector('#target').addEventListener('start2', function () {
            playSound('#hah1');
            ['#song','#song2','#song4','#song5','#song6'].forEach(pauseSound);
            playSound('#song3');
          });
          document.querySelector('#target').addEventListener('start3', function () {
            playSound('#hah2');
            ['#song','#song2','#song3','#song5','#song6'].forEach(pauseSound);
            playSound('#song4');
          });
          document.querySelector('#target').addEventListener('start4', function () {
            playSound('#hah3');
            ['#song','#song2','#song3','#song4','#song6'].forEach(pauseSound);
            playSound('#song5');
          });
          document.querySelector('#target').addEventListener('start5', function () {
            playSound('#hah1');
            ['#song','#song2','#song3','#song4','#song5'].forEach(pauseSound);
            playSound('#song6');
            boss = true;
            setTimeout(function(){ playSound('#hah1'); }, 4500);
            setTimeout(function(){ playSound('#hah2'); }, 4500);
            setTimeout(function(){ playSound('#hah3'); }, 4500);
          });

          // Scoring tick to simulate progress (replace with collision-based scoring if you add collectibles)
          setInterval(() => {
            if (!scoring) return;
            score += 10;
            setNText(document.querySelector('#scoreshow'), { text:'<color=#6FF3E8>' + score });
          }, 2000);

          // Boss laugh loop
          setInterval(() => { if (boss) playSound('#hah1'); }, 25000);

          // OOB mapping: click triggers portal out
          document.querySelector('#oob').addEventListener('click', () => {
            emitToTargets('outgo', ['#outstart']);
          });
        });

        function playSound(sel) {
          const el = document.querySelector(sel);
          if (el?.components?.sound) el.components.sound.playSound();
        }
        function pauseSound(sel) {
          const el = document.querySelector(sel);
          if (el?.components?.sound) el.components.sound.pauseSound();
        }

        function reset() {
          if (gameStarted) {
            if (score >= 50) {
              lastscore5 = lastscore4;
              lastscore4 = lastscore3;
              lastscore3 = lastscore2;
              lastscore2 = lastscore;
              lastscore = score;
            }
            emitToTargets('startport', ['#outstart']);
            if (score >= 15) playSound('#gameovers');

            gameStarted = false;
            scoring = false;
            boss = false;

            setNText(document.querySelector('#lastscore'), { text:'<color=#6FF3E8>' + lastscore });
            setNText(document.querySelector('#lastscore2'), { text:'<color=#6FF3E8>' + lastscore2 });
            setNText(document.querySelector('#lastscore3'), { text:'<color=#6FF3E8>' + lastscore3 });
            setNText(document.querySelector('#lastscore4'), { text:'<color=#6FF3E8>' + lastscore4 });
            setNText(document.querySelector('#lastscore5'), { text:'<color=#6FF3E8>' + lastscore5 });
            document.querySelector('#joinh').setAttribute('position', '5.1 12 0');
            score = 0;
            setNText(document.querySelector('#scoreshow'), { text:'<color=#6FF3E8> 0' });
            setTimeout(function() { gameStarted = true; }, 5000);
          }
        }
      </script>
    </a-scene>
  </body>
</html>
