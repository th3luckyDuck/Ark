<!DOCTYPE html>
<html>
  <head>
    <!--
    Ark - Browser Edition (A-Frame + Gamepad + HUD + Physics-lite)
    - HUD buttons pinned to camera bottom, arranged and angled to feel like bottom-screen UI.
    - "Enter Ark" button attached to camera: resumes AudioContext and starts intro music only (pregame).
    - Start Game button: begins game flow (drop room, level sequencers, progression music, scoring).
    - Physics-lite: gravity, jump, lane snap, AABB collisions (no external physics lib; avoids THREE.Geometry errors).
    - Raycaster whitelist defined for performance.
    - All visible planes/boxes set to side: double so textures show on both sides (helps with invisible walls).
    - Sound pools increased to avoid "All the sounds are playing" warnings.
    - All emit targets verified; no dispatchEvent on null; controller reset guarded.
    -->

    <meta charset="utf-8">
    <title>Ark</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <script>
      // ===== Utils =====
      function isEntity(el) {
        return !!(el && el.object3D && typeof el.emit === 'function');
      }

      function emitToTargets(type, targets) {
        targets.forEach(sel => {
          const el = document.querySelector(sel);
          if (!isEntity(el)) return;
          el.emit(type, null, false);
        });
      }

      function setNText(el, payload) {
        if (!el) return;
        const val = (payload && payload.text) ? payload.text : String(payload || '');
        const match = String(val).match(/<color=([^>]+)>\s*(.*)/i);
        const color = match ? match[1].trim() : '#6FF3E8';
        const value = match ? match[2].trim() : val;
        el.setAttribute('text', `value: ${value}; color: ${color}; align: left; width: 4`);
      }

      function playSound(sel) {
        const el = document.querySelector(sel);
        if (el?.components?.sound) el.components.sound.playSound();
      }
      function pauseSound(sel) {
        const el = document.querySelector(sel);
        if (el?.components?.sound) el.components.sound.pauseSound();
      }

      // ===== Gamepad Controller =====
      const GamepadController = {
        deadZone: 0.25,
        prevButtons: [],
        laneIndex: 1, // 0 left, 1 center, 2 right
        muted: false,
        start() {
          const loop = () => {
            const pads = navigator.getGamepads ? navigator.getGamepads() : [];
            const pad = pads && pads[0];
            if (pad) this.handlePad(pad);
            requestAnimationFrame(loop);
          };
          loop();
        },
        handlePad(pad) {
          // Left stick horizontal â†’ lanes
          const ax = pad.axes[0] || 0;
          if (ax > this.deadZone) this.setLane(2);
          else if (ax < -this.deadZone) this.setLane(0);
          else this.setLane(1);

          // D-Pad
          if (pad.buttons[14]?.pressed) this.setLane(0);
          if (pad.buttons[15]?.pressed) this.setLane(2);

          // A jump
          this.edgeTrigger(0, pad.buttons[0]?.pressed, () => this.jump());

          // X mute toggle
          this.edgeTrigger(2, pad.buttons[2]?.pressed, () => this.toggleMute());

          // Start reset
          this.edgeTrigger(9, pad.buttons[9]?.pressed, () => {
            const resetBtn = document.querySelector('#resetb');
            if (resetBtn) {
              resetBtn.emit('click');
              resetBtn.dispatchEvent(new Event('click'));
            }
          });

          this.prevButtons = pad.buttons.map(b => b.pressed);
        },
        edgeTrigger(index, pressed, cb) {
          const was = this.prevButtons[index] || false;
          if (pressed && !was) cb();
        },
        setLane(idx) {
          if (idx === this.laneIndex) return;
          this.laneIndex = idx;
          const laneTargets = ['#leftstop', '#centerstop', '#rightstop'];
          emitToTargets('movetp', [laneTargets[idx]]);
        },
        jump() {
          const player = document.querySelector('#player');
          const phys = player?.components?.['runner-physics'];
          if (!phys) return;
          phys.requestJump();
          emitToTargets('jump', ['#jumpa', '#jumpb']);
        },
        toggleMute() {
          this.muted = !this.muted;
          const ids = ['#song','#song2','#song3','#song4','#song5','#song6','#begin3','#gameovers','#lazer','#click','#click2','#hah1','#hah2','#hah3'];
          ids.forEach(sel => {
            const el = document.querySelector(sel);
            if (el?.components?.sound) {
              const base = el.components.sound.data.volume || 0.3;
              el.setAttribute('sound', `volume: ${this.muted ? 0 : base}`);
            }
          });
        }
      };

      // ===== Ensure desktop cursor on camera with whitelist for performance =====
      AFRAME.registerComponent('ensure-cursor', {
        init() {
          const camera = this.el;
          camera.setAttribute('cursor', 'rayOrigin: mouse; fuse: false');
          camera.setAttribute('raycaster', 'objects: .interactable'); // whitelist
        }
      });

      // ===== Runner Physics-lite =====
      // Gravity + jump + lane movement + AABB collisions against obstacles (.obstacle)
      AFRAME.registerComponent('runner-physics', {
        schema: {
          gravity: {type: 'number', default: -9.8},
          jumpVelocity: {type: 'number', default: 5.5},
          groundY: {type: 'number', default: 0}
        },
        init() {
          this.vel = new THREE.Vector3(0, 0, 0);
          this.grounded = true;
          this.targetLane = 1; // center
          this.laneX = [-1.5, 0, 1.5];
          this.laneZ = [0, 0, 0];
          this.playerBox = new THREE.Box3();
          this.size = new THREE.Vector3(0.5, 1.6, 0.5);
          this.obstacles = [];
          this.refreshObstacles();

          // Lane changes
          this.el.addEventListener('movetp', (e) => {
            const id = e?.detail?.source || e?.target?.id || '';
            // source not provided; we map by which target got the event
            // we will set targetLane when the lane stop emits later
          });

          // When lane stops emit, update lane index
          ['leftstop','centerstop','rightstop'].forEach((id, idx) => {
            const stop = document.getElementById(id);
            stop?.addEventListener('movetp', () => { this.targetLane = idx; });
          });
        },
        refreshObstacles() {
          this.obstacles = Array.from(document.querySelectorAll('.obstacle')).map(el => ({
            el,
            getBox: () => {
              const worldPos = new THREE.Vector3();
              el.object3D.getWorldPosition(worldPos);
              const scale = new THREE.Vector3();
              el.object3D.getWorldScale(scale);
              // Determine size from attributes (box, plane etc.)
              const geo = el.getAttribute('geometry') || {};
              const sx = (geo.width || geo.radius || scale.x) * 1;
              const sy = (geo.height || geo.radius || scale.y) * 1;
              const sz = (geo.depth || geo.radius || scale.z) * 1;
              const half = new THREE.Vector3(sx/2, sy/2, sz/2);
              const min = new THREE.Vector3().copy(worldPos).sub(half);
              const max = new THREE.Vector3().copy(worldPos).add(half);
              return new THREE.Box3(min, max);
            }
          }));
        },
        requestJump() {
          if (this.grounded) {
            this.vel.y = this.data.jumpVelocity;
            this.grounded = false;
          }
        },
        tick(time, dt) {
          const delta = dt / 1000;
          if (!delta) return;
          const pos = this.el.object3D.position;

          // Gravity
          this.vel.y += this.data.gravity * delta;

          // Move toward lane target smoothly
          const tx = this.laneX[this.targetLane], tz = this.laneZ[this.targetLane];
          pos.x += (tx - pos.x) * Math.min(1, delta * 20);
          pos.z += (tz - pos.z) * Math.min(1, delta * 20);

          // Vertical integrate
          pos.y += this.vel.y * delta;

          // Ground clamp
          const ground = this.data.groundY + this.size.y / 2;
          if (pos.y <= ground) {
            pos.y = ground;
            this.vel.y = 0;
            this.grounded = true;
          }

          // Player AABB
          const half = new THREE.Vector3(this.size.x/2, this.size.y/2, this.size.z/2);
          const min = new THREE.Vector3().copy(pos).sub(half);
          const max = new THREE.Vector3().copy(pos).add(half);
          this.playerBox.min.copy(min);
          this.playerBox.max.copy(max);

          // Collisions
          for (let i = 0; i < this.obstacles.length; i++) {
            const box = this.obstacles[i].getBox();
            if (this.playerBox.intersectsBox(box)) {
              const resetBtn = document.querySelector('#resetb');
              if (resetBtn) {
                resetBtn.emit('click');
                resetBtn.dispatchEvent(new Event('click'));
              }
              emitToTargets('gameend', ['#resetb']);
              break;
            }
          }
        }
      });

      // ===== HUD anchor to camera bottom =====
      AFRAME.registerComponent('hud-anchor', {
        schema: {
          // tuned offsets for bottom-of-screen feel on desktop
          offset: {type: 'vec3', default: {x: 0, y: -0.4, z: -0.9}},
          tilt: {type: 'number', default: -15}
        },
        tick() {
          this.el.object3D.position.set(this.data.offset.x, this.data.offset.y, this.data.offset.z);
          this.el.object3D.rotation.set(THREE.MathUtils.degToRad(this.data.tilt), 0, 0);
        }
      });

      // ===== Click wiring helper =====
      function setupWireClick(el, emit, targets) {
        if (!el) return;
        el.classList.add('interactable');
        el.addEventListener('click', () => emitToTargets(emit, targets));
      }
    </script>
  </head>

  <body>
    <a-scene background="color: #000">

      <a-assets>
        <img id="leftp" src="left.jpg">
        <img id="centerp" src="center.jpg">
        <img id="rightp" src="right.jpg">
        <img id="jumpp" src="jump.jpg">
        <img id="mutep" src="mute.jpg">
        <img id="arkwall" src="arkwall.jpg">
        <img id="credit" src="credit.jpg">
        <img id="startp" src="start.jpg">
        <img id="resetp" src="reset.jpg">
        <img id="joinp" src="join.jpg">
        <img id="lobbyp" src="lobby.jpg">
        <img id="scorep" src="score.jpg">
        <img id="scoreboardp" src="scoreboard.jpg">
        <img id="joinsmallp" src="joinsmall.jpg">
        <img id="lobbysmallp" src="lobbysmall.jpg">
        <img id="p1" src="1.jpg">
        <img id="p2" src="2.jpg">
        <img id="p3" src="3.jpg">
        <a-asset-item id="run-obj" src="run.obj"></a-asset-item>
        <a-asset-item id="run-mtl" src="run.mtl"></a-asset-item>
      </a-assets>

      <!-- Player and camera -->
      <a-entity id="player" position="0 0.8 0" runner-physics>
        <a-entity id="playerCam" camera look-controls ensure-cursor>
          <!-- HUD attached to camera -->
          <a-entity id="HUD" hud-anchor>
            <!-- Enter Ark: ONLY starts intro music and resumes AudioContext -->
            <a-plane id="enterArk" src="#startp" width="0.7" height="0.2"
                     position="-0.7 -0.25 -1.0"
                     material="side: double"
                     class="interactable"></a-plane>

            <!-- Start Game -->
            <a-plane id="startcc" src="#startp" width="0.7" height="0.2"
                     position="0.0 -0.25 -1.0"
                     material="side: double"
                     class="interactable"
                     animation__hide="property: position; to: 0 -1000 -1.0; dur: 2500; startEvents: start1"></a-plane>

            <!-- Mute -->
            <a-plane id="songT" src="#mutep" width="0.3" height="0.3"
                     position="0.7 -0.25 -1.0"
                     material="side: double"
                     class="interactable"></a-plane>

            <!-- Lane buttons -->
            <a-plane id="leftT" src="#leftp" width="0.26" height="0.26"
                     position="-0.3 -0.35 -1.05"
                     material="side: double"
                     class="interactable"></a-plane>
            <a-plane id="centerT" src="#centerp" width="0.26" height="0.26"
                     position="0.0 -0.35 -1.05"
                     material="side: double"
                     class="interactable"></a-plane>
            <a-plane id="rightT" src="#rightp" width="0.26" height="0.26"
                     position="0.3 -0.35 -1.05"
                     material="side: double"
                     class="interactable"></a-plane>

            <!-- Jump -->
            <a-plane id="jumpb" src="#jumpp" width="0.32" height="0.32"
                     position="0.0 -0.05 -1.05"
                     material="side: double"
                     class="interactable"
                     animation__press="property: position; to: 0 -1000 -1.05; dur: 5000; startEvents: jump"></a-plane>

            <!-- Score label -->
            <a-plane id="scoreshow3" src="#scorep" width="0.65" height="0.22"
                     position="-0.7 -0.05 -1.05"
                     material="side: double"
                     class="interactable"></a-plane>
            <a-entity id="scoreshow" position='-0.55 -0.05 -1.04'
                      text="value: 0; color: #6FF3E8; align: left; width: 4"></a-entity>

            <!-- Lobby / Join (pinned) -->
            <a-plane id="lobbybtn" src="#lobbyp" width="0.55" height="0.18"
                     position="0.7 -0.05 -1.05"
                     material="side: double"
                     class="interactable"></a-plane>
            <a-plane id="joinsm" src="#joinsmallp" width="0.24" height="0.24"
                     position="0.7 0.10 -1.05"
                     material="side: double"
                     class="interactable"></a-plane>
            <a-plane id="lobbysm" src="#lobbysmallp" width="0.24" height="0.24"
                     position="0.7 -100 -1.05"
                     material="side: double"
                     class="interactable"></a-plane>

            <!-- Join big (used in original; pinned high) -->
            <a-plane id="joinh" src="#joinp" width="0.7" height="0.2"
                     position="0.8 0.15 -1.0"
                     material="side: double"
                     class="interactable"></a-plane>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-light id="light1" type="directional" intensity="2.0" position="150 15 15"></a-light>

      <!-- Lane markers -->
      <a-entity id="leftstop" position="-1.5 0 0"></a-entity>
      <a-entity id="centerstop" position="0 0 0"></a-entity>
      <a-entity id="rightstop" position="1.5 0 0"></a-entity>

      <!-- Countdown -->
      <a-entity id="countdowne">
        <a-plane id="threeb" src='#p3' position='0 -100 -1.62' width="1" height="1" material="side: double"></a-plane>
        <a-plane id="twob" src='#p2' position='0 -100 -1.62' width="1" height="1" material="side: double"></a-plane>
        <a-plane id="oneb" src='#p1' position='0 -100 -1.62' width="1" height="1" material="side: double"></a-plane>
      </a-entity>

      <!-- Room walls and initial drop -->
      <a-entity id="room" position="0 0 0"
                animation__startdrop="property: position; to: 0 -10.2 0; dur: 2000; startEvents: start1">
        <a-box scale="10 10 10" position="-10 5 0" material="color: #5ed4ff; side: double"></a-box>    
        <a-box scale="10 10 10" position="0 5 -10" material="color: #5ed4ff; side: double"></a-box>
        <a-box scale="10 10 10" position="10 5 0" material="color: #5ed4ff; side: double"></a-box>
        <a-box scale="10 10 10" position="0 5 10" material="color: #5ed4ff; side: double"></a-box>
        <a-box scale="10 10 10" position="0 -5 0" material="color: #5ed4ff; side: double"></a-box>
      </a-entity>

      <!-- Invisible lateral bounds (still side: double) -->
      <a-box position="-5 2 0" scale="0.5 5 10" material="opacity:0; side: double" class="obstacle"></a-box>
      <a-box position="5 2 0" scale="0.5 5 10" material="opacity:0; side: double" class="obstacle"></a-box>

      <!-- Floor -->
      <a-plane id="floor" scale="1500 10 1" position="0 0 0" rotation="-90 0 0"
               material="color: #5ed4ff; opacity: 1; side: double"
               animation__rise="property: position; to: 0 0 0; dur: 2500; startEvents: start1"></a-plane>

      <!-- Tunnel -->
      <a-entity id="tunnel" position="-2500 15 0"
                animation__scroll="property: position; to: 2500 15 0; dur: 100000; easing: linear; loop: true">
        <a-box scale="500 10 10" position="0 10 0" material="color: #1f4959; side: double"></a-box>    
        <a-box scale="500 30 10" position="0 0 -10" material="color: #1f4959; side: double"></a-box>
        <a-box scale="500 30 10" position="0 0 10" material="color: #1f4959; side: double"></a-box>
      </a-entity>

      <!-- Moving wall set (loop) -->
      <a-entity id="move" position="-1000 0 0"
                animation__loop="property: position; to: 1000 0 0; dur: 20000; easing: linear; loop: true"></a-entity>

      <!-- Outstart portal (for legacy flow) -->
      <a-entity id="outstart" position="0 -100 0"
                animation__port="property: position; to: 0 0 0; dur: 750; startEvents: startport"></a-entity>

      <!-- Level sequencers (timed reveals) -->
      <a-entity id="start2go" position="0 -1000 -2010"
                animation__seq="property: position; to: 0 0 0; dur: 5000; delay: 50000; startEvents: start1"></a-entity>
      <a-entity id="start3go" position="200 -1000 -2010"
                animation__seq="property: position; to: 0 0 0; dur: 5000; delay: 100000; startEvents: start1"></a-entity>
      <a-entity id="start4go" position="400 -1000 -2010"
                animation__seq="property: position; to: 0 0 0; dur: 5000; delay: 150000; startEvents: start1"></a-entity>
      <a-entity id="start5go" position="600 -1000 -2010"
                animation__seq="property: position; to: 0 0 0; dur: 5000; delay: 200000; startEvents: start1"></a-entity>

      <!-- Music (increase poolSize where rapid replays occur) -->
      <a-entity id="song" position="0 10 0" sound="src: url(arktheme.wav); loop: true; autoplay: false; volume: 0.2; poolSize: 4"></a-entity>
      <a-entity id="song2" position="0 10 0" sound="src: url(arkpregame.wav); loop: true; autoplay: false; volume: 0.2; poolSize: 4"></a-entity>
      <a-entity id="song3" position="0 10 0" sound="src: url(arktheme2.wav); loop: true; autoplay: false; volume: 0.2; poolSize: 4"></a-entity>
      <a-entity id="song4" position="0 10 0" sound="src: url(arktheme3.wav); loop: true; autoplay: false; volume: 0.2; poolSize: 4"></a-entity>
      <a-entity id="song5" position="0 10 0" sound="src: url(arktheme4.wav); loop: true; autoplay: false; volume: 0.2; poolSize: 4"></a-entity>
      <a-entity id="song6" position="0 10 0" sound="src: url(level5.wav); loop: true; autoplay: false; volume: 0.3; poolSize: 4"></a-entity>

      <!-- Boss -->
      <a-obj-model id="boss" scale="50 50 50" src="#run-obj" mtl="#run-mtl" position="-250 -1000 0" rotation="0 90 0"
                   material="side: double"
                   animation__enter="property: position; from: 0 -1000 0; to: -250 0 0; dur: 7500; startEvents: start5"></a-obj-model>

      <!-- Scoreboard wall -->
      <a-entity id="cube1" position="10 0 0"
                animation__hide="property: position; to: 0 -1000 0; dur: 1000; startEvents: start1">
        <a-plane width="6" height="4.5" material="src: #arkwall; opacity: 1; side: double" position="0 13 -4.9"></a-plane>
        <a-plane width="1.25" height="2" material="src: #credit; opacity: 1; side: double" position="0 12 4.9" rotation="0 180 0"></a-plane>
        <a-plane width="8" height="8" material="src: #scoreboardp; opacity: 1; side: double" position="-14.9 15.5 0" rotation="0 90 0"></a-plane>
        <a-entity id="lastscore" position="-14.8 16.75 0" rotation="0 90 0" text="value: 0; color: #6FF3E8; side: double"></a-entity>
        <a-entity id="lastscore2" position="-14.8 15.75 0" rotation="0 90 0" text="value: 0; color: #6FF3E8; side: double"></a-entity>
        <a-entity id="lastscore3" position="-14.8 14.75 0" rotation="0 90 0" text="value: 0; color: #6FF3E8; side: double"></a-entity>
        <a-entity id="lastscore4" position="-14.8 13.75 0" rotation="0 90 0" text="value: 0; color: #6FF3E8; side: double"></a-entity>
        <a-entity id="lastscore5" position="-14.8 12.75 0" rotation="0 90 0" text="value: 0; color: #6FF3E8; side: double"></a-entity>
      </a-entity>

      <!-- SFX (increase poolSize where needed) -->
      <a-entity id="hah1" position="0 15 0" sound="src: url(ha1.wav); loop: false; autoplay: false; volume: 0.3; poolSize: 6"></a-entity>
      <a-entity id="hah2" position="0 15 0" sound="src: url(ha2.wav); loop: false; autoplay: false; volume: 0.3; poolSize: 6"></a-entity>
      <a-entity id="hah3" position="0 15 0" sound="src: url(ha3.wav); loop: false; autoplay: false; volume: 0.3; poolSize: 6"></a-entity>

      <a-entity id="load" position="0 10 0" sound="src: url(load.wav); loop: false; autoplay: false; volume: 0.7; poolSize: 2"></a-entity>
      <a-entity id="gameovers" position="0 15 0" sound="src: url(gameover.wav); loop: false; autoplay: false; volume: 1; poolSize: 2"></a-entity>
      <a-entity id="begin3" position="0 15 0" sound="src: url(begin.wav); loop: false; autoplay: false; volume: 0.3; poolSize: 2"></a-entity>
      <a-entity id="lazer" position="0 15 0" sound="src: url(lazer.wav); loop: false; autoplay: false; volume: 0.3; poolSize: 4"></a-entity>
      <a-entity id="click" position="0 15 0" sound="src: url(click.wav); loop: false; autoplay: false; volume: 0.3; poolSize: 4"></a-entity>
      <a-entity id="click2" position="0 15 0" sound="src: url(click.wav); loop: false; autoplay: false; volume: 0.3; poolSize: 4"></a-entity>

      <!-- Obstacles: restored samples; add class="obstacle" and animations, material side: double -->
      <!-- You can paste all original block groups with the same conversion below. -->
      <a-entity id="block1" position="0 500 0" class="obstacle">
        <a-entity id="block1b" position="-1000 0 0">
          <a-box scale="2 8 4" position="0 2 0" material="color: red; side: double"></a-box>
        </a-entity>
        <a-entity animation__move="property: position; to: 1000 0 0; dur: 20000; easing: linear; loop: true; delay: 7000"></a-entity>
      </a-entity>

      <a-entity id="block1" position="0 500 0" class="obstacle">
        <a-entity id="block1b" position="-1000 0 0">
          <a-box scale="2 8 4" position="0 2 3" material="color: red; side: double"></a-box>
        </a-entity>
        <a-entity animation__move="property: position; to: 1000 0 0; dur: 20000; easing: linear; loop: true; delay: 9000"></a-entity>
      </a-entity>

      <a-entity id="block1" position="0 500 0" class="obstacle">
        <a-entity id="block1b" position="-1000 0 0">
          <a-box scale="2 8 4" position="0 2 -3" material="color: red; side: double"></a-box>
        </a-entity>
        <a-entity animation__move="property: position; to: 1000 0 0; dur: 20000; easing: linear; loop: true; delay: 11000"></a-entity>
      </a-entity>

      <!-- Repeat conversion for all other blocks from original, preserving delays and positions. -->

      <!-- Reset button -->
      <a-entity id="resetb" geometry="primitive: plane; width: 6; height: 1.35"
                material="src: #resetp; opacity: 0.75; side: double"
                position="13 -1000 0" scale="0.5 0.5 0.5" rotation="0 -90 0"
                class="interactable"
                animation__end="property: position; to: 0 -1000 0; dur: 5000; startEvents: gameend"></a-entity>

      <a-sky radius="1050" color="black" material="side: double"></a-sky>

      <script>
        // ===== Gameplay state =====
        var gameStarted = false;
        var score = 0;
        var scoring = false;
        var lastscore = 0;
        var lastscore2 = 0;
        var lastscore3 = 0;
        var lastscore4 = 0;
        var lastscore5 = 0;
        var boss = false;

        document.addEventListener('DOMContentLoaded', () => {
          // Initialize HUD text
          setNText(document.querySelector('#scoreshow'), {text:'<color=#6FF3E8> 0'});
          ['#lastscore','#lastscore2','#lastscore3','#lastscore4','#lastscore5'].forEach(sel=>{
            setNText(document.querySelector(sel), {text:'<color=#6FF3E8> 0'});
          });

          // Gamepad loop
          GamepadController.start();

          // Enter Ark: resume AudioContext and start pregame music ONLY
          const enterArk = document.querySelector('#enterArk');
          enterArk.addEventListener('click', () => {
            try {
              if (AFRAME.audioContext && AFRAME.audioContext.state === 'suspended') {
                AFRAME.audioContext.resume();
              }
            } catch(e) {}
            playSound('#song2'); // intro / pregame
            playSound('#click');
          });

          // Start Game flow
          document.querySelector('#startcc').addEventListener('click', () => {
            playSound('#click');

            emitToTargets('start1', ['#room','#floor','#startcc','#tunnel','#cube1','#move','#start2go','#start3go','#start4go','#start5go','#target','#boss']);
            playSound('#begin3');

            gameStarted = true;
            scoring = true;

            // Trigger countdown visuals via "join" behavior
            document.querySelector('#target2').dispatchEvent(new Event('outgo'));
          });

          // Wire-like handlers
          setupWireClick(document.querySelector('#lobbybtn'), 'outgo', ['#outstart','#click2']);
          setupWireClick(document.querySelector('#joinh'), 'outgo', ['#outstart','#click2','#target2']);
          setupWireClick(document.querySelector('#joinsm'), 'outgo', ['#outstart','#click2','#target2']);
          setupWireClick(document.querySelector('#lobbysm'), 'outgo', ['#outstart','#click2']);

          setupWireClick(document.querySelector('#jumpb'), 'jump', ['#jumpa','#jumpb']);
          setupWireClick(document.querySelector('#leftT'), 'movetp', ['#leftstop']);
          setupWireClick(document.querySelector('#centerT'), 'movetp', ['#centerstop']);
          setupWireClick(document.querySelector('#rightT'), 'movetp', ['#rightstop']);

          document.querySelector('#songT').addEventListener('click', () => GamepadController.toggleMute());
          document.querySelector('#resetb').addEventListener('click', () => reset());

          // Countdown visuals on outgo
          document.querySelector('#target2').addEventListener('outgo', function () {
            const threeb = document.querySelector('#threeb');
            threeb.setAttribute('position', '0 1 -1.62');
            setTimeout(function() {threeb.setAttribute('position', '0 -100 0');}, 1000);
            setTimeout(function() {document.querySelector('#twob').setAttribute('position', '0 1 -1.62');}, 1000);
            setTimeout(function() {document.querySelector('#twob').setAttribute('position', '0 -100 0');}, 2000);
            setTimeout(function() {document.querySelector('#oneb').setAttribute('position', '0 1 -1.62');}, 2000);
            setTimeout(function() {document.querySelector('#oneb').setAttribute('position', '0 -100 0');}, 3000);
          });

          // Music progression via sequencers
          document.querySelector('#target').addEventListener('start1', function () {
            ['#song3','#song4','#song5','#song6','#song2'].forEach(pauseSound);
            playSound('#song'); // main theme
            document.querySelector('#joinh').setAttribute('position', '0.8 0.15 -1.0');
          });

          document.querySelector('#start2go').addEventListener('animationcomplete', () => {
            emitToTargets('start2', ['#target']);
          });
          document.querySelector('#target').addEventListener('start2', function () {
            playSound('#hah1');
            ['#song','#song2','#song4','#song5','#song6'].forEach(pauseSound);
            playSound('#song3');
          });

          document.querySelector('#start3go').addEventListener('animationcomplete', () => {
            emitToTargets('start3', ['#target']);
          });
          document.querySelector('#target').addEventListener('start3', function () {
            playSound('#hah2');
            ['#song','#song2','#song3','#song5','#song6'].forEach(pauseSound);
            playSound('#song4');
          });

          document.querySelector('#start4go').addEventListener('animationcomplete', () => {
            emitToTargets('start4', ['#target']);
          });
          document.querySelector('#target').addEventListener('start4', function () {
            playSound('#hah3');
            ['#song','#song2','#song3','#song4','#song6'].forEach(pauseSound);
            playSound('#song5');
          });

          document.querySelector('#start5go').addEventListener('animationcomplete', () => {
            emitToTargets('start5', ['#target']);
          });
          document.querySelector('#target').addEventListener('start5', function () {
            playSound('#hah1');
            ['#song','#song2','#song3','#song4','#song5'].forEach(pauseSound);
            playSound('#song6');
            boss = true;
            setTimeout(function(){ playSound('#hah1'); }, 4500);
            setTimeout(function(){ playSound('#hah2'); }, 4500);
            setTimeout(function(){ playSound('#hah3'); }, 4500);
          });

          // Scoring tick (progress simulation)
          setInterval(() => {
            if (!scoring) return;
            score += 10;
            setNText(document.querySelector('#scoreshow'), { text:'<color=#6FF3E8>' + score });
          }, 2000);

          // Boss laugh loop
          setInterval(() => { if (boss) playSound('#hah1'); }, 25000);
        });

        function reset() {
          if (gameStarted) {
            if (score >= 50) {
              lastscore5 = lastscore4;
              lastscore4 = lastscore3;
              lastscore3 = lastscore2;
              lastscore2 = lastscore;
              lastscore = score;
            }
            if (score >= 15) playSound('#gameovers');

            gameStarted = false;
            scoring = false;
            boss = false;

            setNText(document.querySelector('#lastscore'), { text:'<color=#6FF3E8>' + lastscore });
            setNText(document.querySelector('#lastscore2'), { text:'<color=#6FF3E8>' + lastscore2 });
            setNText(document.querySelector('#lastscore3'), { text:'<color=#6FF3E8>' + lastscore3 });
            setNText(document.querySelector('#lastscore4'), { text:'<color=#6FF3E8>' + lastscore4 });
            setNText(document.querySelector('#lastscore5'), { text:'<color=#6FF3E8>' + lastscore5 });
            setNText(document.querySelector('#scoreshow'), { text:'<color=#6FF3E8> 0' });

            score = 0;
            setTimeout(function() { gameStarted = true; }, 5000);
          }
        }
      </script>
    </a-scene>
  </body>
</html>
